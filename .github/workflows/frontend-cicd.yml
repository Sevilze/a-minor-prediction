name: Build and Deploy Frontend to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - "*.tsx"
      - "*.ts"
      - "*.html"
      - "*.json"
      - "components/**"
      - "hooks/**"
      - "services/**"
      - ".github/workflows/frontend-cicd.yml"
    paths-ignore:
      - "backend/**"
      - "rustreference/**"
      - "trainingpipeline/**"
  pull_request:
    branches:
      - main
    paths:
      - "*.tsx"
      - "*.ts"
      - "*.html"
      - "*.json"
      - "components/**"
      - "hooks/**"
      - "services/**"
      - ".github/workflows/frontend-cicd.yml"
    paths-ignore:
      - "backend/**"
      - "rustreference/**"
      - "trainingpipeline/**"
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  REGION: asia-southeast2
  IMAGE_NAME: asia-southeast2-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPOSITORY }}/chordai-frontend

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

  build-and-deploy:
    needs: lint-and-typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WORKLOAD_IDENTITY_POOL }}/providers/github-provider"
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Create Dockerfile for static hosting
        run: |
          cat > Dockerfile.frontend << 'EOF'
          FROM nginx:alpine
          COPY dist /usr/share/nginx/html
          COPY nginx.conf /etc/nginx/conf.d/default.conf
          EXPOSE 8080
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Create nginx configuration
        run: |
          cat > nginx.conf << 'EOF'
          server {
              listen 8080;
              server_name _;
              root /usr/share/nginx/html;
              index index.html;

              location / {
                  try_files $uri $uri/ /index.html;
              }

              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }

              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
          }
          EOF

      - name: Build and push Docker image
        run: |
          docker build -f Dockerfile.frontend -t $IMAGE_NAME:${{ github.sha }} -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:latest

      - name: Deploy to Cloud Run
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          gcloud run deploy chordai-frontend \
            --image $IMAGE_NAME:${{ github.sha }} \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --max-instances 5 \
            --port 8080

      - name: Show deployment URL
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          gcloud run services describe chordai-frontend --region $REGION --format 'value(status.url)'
